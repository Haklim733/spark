{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Comprehensive Job and Spark Partition Metrics Schema for ELT Pipeline",
  "description": "Schema capturing ALL metrics from HybridLogger: job-level, partition-level, operation-level, performance, business events, errors, and custom metrics with Spark-native partitioning",
  "schema_version": "v3",
  "type": "object",
  "properties": {
    "job_id": {
      "type": "string",
      "description": "Unique job identifier for the entire application run (HybridLogger job_id)"
    },
    "source": {
      "type": "string",
      "enum": ["local", "minio", "s3", "hdfs", "api"],
      "description": "Source system identifier"
    },
    "target_table": {
      "type": "string",
      "description": "Target table name for the batch load"
    },
    "version": {
      "type": "string",
      "description": "Schema/process version for compatibility tracking"
    },
    
    "job_start": {
      "type": "string",
      "format": "date-time",
      "description": "When the entire job/application started (HybridLogger start_time)"
    },
    "job_end": {
      "type": "string",
      "format": "date-time",
      "description": "When the entire job/application completed (HybridLogger shutdown)"
    },
    
    "operation_name": {
      "type": "string",
      "description": "Name of the operation being tracked (from HybridLogger start_operation/end_operation)"
    },
    "operation_start": {
      "type": "string",
      "format": "date-time",
      "description": "When the operation started"
    },
    "operation_end": {
      "type": "string",
      "format": "date-time",
      "description": "When the operation completed"
    },
    "operation_result_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of results from the operation"
    },
    
    "records_processed": {
      "type": "integer",
      "minimum": 0,
      "description": "Total number of individual records processed across all files in this partition"
    },
    "records_loaded": {
      "type": "integer",
      "minimum": 0,
      "description": "Total number of individual records successfully loaded"
    },
    "records_failed": {
      "type": "integer",
      "minimum": 0,
      "description": "Total number of individual records that failed to load"
    },
    "records_missing": {
      "type": "integer",
      "minimum": 0,
      "description": "Total number of individual records that were expected but not found"
    },
    
    "record_size_bytes": {
      "type": "integer",
      "minimum": 0,
      "description": "Total size of all records processed in bytes"
    },
    "bytes_transferred": {
      "type": "integer",
      "minimum": 0,
      "description": "Total bytes transferred/processed"
    },
    "performance_operation": {
      "type": "string",
      "description": "Operation name from performance metrics (HybridLogger log_performance)"
    },
    "performance_execution_time_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Execution time from performance metrics"
    },
    "performance_timestamp": {
      "type": "integer",
      "minimum": 0,
      "description": "Timestamp from performance metrics"
    },
    
    "partition_processing_metrics": {
      "type": "object",
      "properties": {
        "partition_id": {
          "type": "integer",
          "minimum": 0,
          "description": "Spark partition ID where the data was processed (spark_partition_id())"
        },
        "partition_count": {
          "type": "integer",
          "minimum": 1,
          "description": "Total number of Spark partitions used for this processing"
        },
        "partition_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of files/records in this specific partition"
        },
        "partition_total_size_bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Total size of all files in this partition in bytes"
        },
        "partition_skew_ratio": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Ratio indicating partition skew (0.0 = perfectly balanced, 1.0 = highly skewed)"
        },
        "partition_start": {
          "type": "string",
          "format": "date-time",
          "description": "When this specific partition processing started"
        },
        "partition_end": {
          "type": "string",
          "format": "date-time",
          "description": "When this specific partition processing completed"
        },
        "partition_processing_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Time spent processing this specific partition (manually tracked)"
        }
      },
      "required": [
        "partition_id",
        "partition_count",
        "partition_size",
        "partition_total_size_bytes",
        "partition_start",
        "partition_end",
        "partition_processing_time_ms"
      ],
      "description": "Partition-specific processing metrics (only metrics that can be reliably captured)"
    },
    
    "business_events_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of business events logged (HybridLogger log_business_event)"
    },
    "business_event_types": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Types of business events encountered"
    },
    
    "error_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of errors logged (HybridLogger log_error)"
    },
    "error_codes": {
      "type": "object",
      "additionalProperties": {
        "type": "integer",
        "minimum": 0
      },
      "description": "Distribution of error codes encountered during load"
    },
    "error_summary": {
      "type": "string",
      "description": "Human-readable summary of load results"
    },
    "error_types": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Types of errors encountered"
    },
    
    "failed_files_by_partition": {
      "type": "object",
      "additionalProperties": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "file_path": {
              "type": "string",
              "description": "Path to the failed file"
            },
            "document_id": {
              "type": "string",
              "description": "Document ID extracted from the file"
            },
            "document_type": {
              "type": "string",
              "description": "Type of document that failed"
            },
            "error_message": {
              "type": "string",
              "description": "Specific error message for this file"
            },
            "error_code": {
              "type": "string",
              "description": "Error code for this failure"
            },
            "record_size_bytes": {
              "type": "integer",
              "minimum": 0,
              "description": "Size of the failed file in bytes"
            },
            "partition_id": {
              "type": "integer",
              "minimum": 0,
              "description": "Spark partition ID where the file was processed"
            },
            "failure_timestamp": {
              "type": "string",
              "format": "date-time",
              "description": "When this file failed processing"
            }
          },
          "required": [
            "file_path",
            "error_message",
            "error_code",
            "partition_id",
            "failure_timestamp"
          ]
        }
      },
      "description": "Detailed mapping of partition IDs to lists of failed files with their specific error information"
    },
    
    "total_logs_generated": {
      "type": "integer",
      "minimum": 0,
      "description": "Total number of log entries generated (HybridLogger get_performance_summary)"
    },
    "async_logging_enabled": {
      "type": "boolean",
      "description": "Whether async logging was enabled"
    },
    
    "validation_status": {
      "type": "string",
      "enum": ["complete_success", "partial_load", "load_failures", "unknown"],
      "description": "Overall validation status of the partition"
    },
    "job_status": {
      "type": "string",
      "enum": ["success", "failed", "partial_success"],
      "description": "Overall job status"
    },
    
    "spark_metrics": {
      "type": "object",
      "properties": {
        "executor_count": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of Spark executors used"
        },
        "executor_memory_mb": {
          "type": "integer",
          "minimum": 1,
          "description": "Memory allocated per executor in MB"
        },
        "driver_memory_mb": {
          "type": "integer",
          "minimum": 1,
          "description": "Memory allocated to driver in MB"
        },
        "spark_version": {
          "type": "string",
          "description": "Spark version used"
        },
        "iceberg_version": {
          "type": "string",
          "description": "Iceberg version used"
        },
        "shuffle_read_bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Total shuffle read bytes"
        },
        "shuffle_write_bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Total shuffle write bytes"
        },
        "total_executor_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Total executor time across all partitions"
        }
      },
      "description": "Spark-specific metrics and configuration"
    },
    
    "created_by": {
      "type": "string",
      "description": "User/system that initiated the load"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "When the record was inserted into this table"
    }
  },
  "required": [
    "job_id",
    "source",
    "target_table",
    "version",
    "job_start",
    "job_end",
    "records_processed",
    "records_loaded",
    "records_failed",
    "records_missing",
    "record_size_bytes",
    "bytes_transferred",
    "error_codes",
    "error_summary",
    "validation_status",
    "job_status",
    "created_by",
    "created_at"
  ],
  "definitions": {
    "error_code": {
      "type": "string",
      "enum": [
        "E001",
        "E002", 
        "E003",
        "E004",
        "E005",
        "E006",
        "E007",
        "E999"
      ],
      "description": "Standardized error codes: E001=FILE_NOT_FOUND, E002=PERMISSION_DENIED, E003=INVALID_FORMAT, E004=SCHEMA_MISMATCH, E005=NETWORK_ERROR, E006=TIMEOUT, E007=MEMORY_ERROR, E999=UNKNOWN_ERROR"
    }
  }
} 